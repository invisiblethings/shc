{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/instrumenting-gatsbyjs-with-sentry/","result":{"data":{"site":{"siteMetadata":{"title":"David Cramer's Blog"}},"markdownRemark":{"id":"c3d94822-057d-584f-886a-fc79e0290ebe","excerpt":"I recently kicked off an initiative to port our developer documentation into a public-facing website. Previously this was split between Sentry’s official docs…","html":"<p>I recently kicked off an initiative to port our developer documentation into a <a href=\"https://develop.sentry.dev\">public-facing website</a>. Previously this was split between Sentry’s official docs (rarely updated), and our internal knowledge base. Making this public was a good way to ensure it was kept up to date, but also an important step in ensuring Sentry’s open source origins stay true. As part of this, we also wanted to give <a href=\"https://www.gatsbyjs.org/\">Gatsby</a> a spin, as working on our Jekyll-based documentation has had a pretty slow iteration speed due to the way it builds pages.</p>\n<p>I’m not going to go into the details of the Gatsby build itself, but the project is <a href=\"https://github.com/getsentry/develop\">open source on GitHub</a> so take a look if you’re interested. Instead I’m going to talk a bit about developing the <code class=\"language-text\">@sentry/gatsby</code> integration, what worked out of the box, and where we still need to improve our new products at Sentry. To follow along take a look at the <a href=\"https://github.com/getsentry/sentry-javascript/tree/master/packages/gatsby\">gatsby package in sentry-javascript</a>.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ea10c762c1747ca8db9bd3d7ad719547/5e703/gatsby-trace.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 75.67567567567568%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACh0lEQVQ4y4VUWWtTURDOL9cHHyo+iA/igyJYRKq1K1IQF1orxbSiVSvpkrRpk9x9zd3XfM5MmjStiAMfc87lnG9mvplzG2EQwTIcOLYHx3LF2+RdxxfPe8t0YOg2oihBWVYoinIGFaIwhuv6yLIcjTwr5GASp0iSjJAK0pn1BHleoCLCcga85+9ZmqGkAI0iLxF4IUI/QEzZVpeHGKN6hJrAaz7HwbMkF6RxJkHZT74VRNyoKrpc5KjzBHWR4eRHF/vbLbS+dtA5uED3cABLdZFElGWYosjGWdZVjYog/jKBoiDCLMswGo0wseP9M3xY3MH2+h52Nr5h7/1PtPbaOP3dQ7fVh96zELih3JlgYnEcoxEMqVwqlevPSdSUtBrShSQalzI41dH5dS7ZnhEhe8HvC5wfDXBxoqDXVgX9roIGM1umDV3TYRomhsMAFFcicvQ+HTw90snr6J3QpbaGfkeT9RRMRt/iIB0Tuo5HhAY81wNrOmt17CJXWrQq8T+r6/qKUKMMPc8XQhaXxyAlCfIoRGW00TvsUoMU5Gku8pQ0fzfBjRFCzszQDZimBVXVoCoaBn1F9jy4bB+XvmBjfhOBH0km0/GSbvN67KeEOhHatiNeI1JN1WWu+CCpia3VXSw9eivdd01/OtRj0n8RWjYsAhObhgXHcWWY2TZXmnh866XgoHksjZt9BNcIXSnZhEFd5pIVRSVdXfj+kLTMhXBrtYmnd15jfm4F7xY+o9dR5ZVUNzL9S0NloAq4bO48Py/JcLmJJ7dfYf7uCp7fW8PW2i4cw7/U8OrVXCO0iJBLH5MqGBCiMBLCT+u7eDa3jIUHb/Di/joWH27g8HtHniRPBf8gGH8Ay0Vqx/0tbEAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"A Gatsby Trace in Sentry\"\n        title=\"A Gatsby Trace in Sentry\"\n        src=\"/static/ea10c762c1747ca8db9bd3d7ad719547/fcda8/gatsby-trace.png\"\n        srcset=\"/static/ea10c762c1747ca8db9bd3d7ad719547/12f09/gatsby-trace.png 148w,\n/static/ea10c762c1747ca8db9bd3d7ad719547/e4a3f/gatsby-trace.png 295w,\n/static/ea10c762c1747ca8db9bd3d7ad719547/fcda8/gatsby-trace.png 590w,\n/static/ea10c762c1747ca8db9bd3d7ad719547/efc66/gatsby-trace.png 885w,\n/static/ea10c762c1747ca8db9bd3d7ad719547/c83ae/gatsby-trace.png 1180w,\n/static/ea10c762c1747ca8db9bd3d7ad719547/5e703/gatsby-trace.png 1942w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">A Gatsby Trace in Sentry</figcaption>\n  </figure></p>\n<p>When I started the integration, I had a rough idea on how to approach it due to an <a href=\"https://www.gatsbyjs.org/packages/gatsby-plugin-sentry/\">existing plugin by octalmage</a>. There were a couple things I wanted to accomplish though which werent present here:</p>\n<ul>\n<li>plugin-based approach (the same as the existing plugin)</li>\n<li>frictionless setup - generally config can be inferred from the environment</li>\n<li>support for Sentry’s new performance monitoring</li>\n</ul>\n<p>I already had the approach for the plugin. It’s fairly straight forward, and just requires a <code class=\"language-text\">gatsby-browser.js</code> to be defined where you’re passed plugin options and can inject the SDK:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onClientEntry</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> pluginParams</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  require<span class=\"token punctuation\">.</span><span class=\"token function\">ensure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"@sentry/react\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">require</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> Sentry <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"@sentry/browser\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Sentry<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      environment<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"development\"</span><span class=\"token punctuation\">,</span>\n      release<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SENTRY_RELEASE</span><span class=\"token punctuation\">,</span>\n      dsn<span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SENTRY_DSN</span><span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span>pluginParams<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    window<span class=\"token punctuation\">.</span>Sentry <span class=\"token operator\">=</span> Sentry<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>There’s a couple of tricky bits in here that won’t actually do what you’d expect:</p>\n<ul>\n<li>Passing <code class=\"language-text\">integrations</code> is actually operating outside of a browser context, meaning we cant initialize <code class=\"language-text\">@sentry/apm</code> from <code class=\"language-text\">pluginParams</code></li>\n<li>While <code class=\"language-text\">NODE_ENV</code> is available, Gatsby wont expose other environment variables to the browser unless prefixed with <code class=\"language-text\">GATSBY_</code>. This means our <code class=\"language-text\">SENTRY_</code> vars won’t exist.</li>\n</ul>\n<p>The first one was easy to work around. We don’t actually need a ton of integrations, so we just created detection for tracing configuration:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onClientEntry</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">_<span class=\"token punctuation\">,</span> pluginParams</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  require<span class=\"token punctuation\">.</span><span class=\"token function\">ensure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'@sentry/react'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'@sentry/apm'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">require</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token keyword\">const</span> TracingIntegration <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@sentry/apm'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Integrations<span class=\"token punctuation\">.</span>Tracing<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> tracesSampleRate <span class=\"token operator\">=</span> pluginParams<span class=\"token punctuation\">.</span>tracesSampleRate <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">?</span> pluginParams<span class=\"token punctuation\">.</span>tracesSampleRate <span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> integrations <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token punctuation\">(</span>pluginParams<span class=\"token punctuation\">.</span>integrations <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tracesSampleRate<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      integrations<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">TracingIntegration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    Sentry<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// ...</span>\n      <span class=\"token operator\">...</span>pluginParams<span class=\"token punctuation\">,</span>\n      tracesSampleRate<span class=\"token punctuation\">,</span>\n      integrations<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>This will only inject <code class=\"language-text\">@sentry/apm</code> when you’ve defined <code class=\"language-text\">tracesSampleRate &gt; 0</code> in your configuration. Great, we’ve solved our first problem!</p>\n<p>The next issue we had was more complex. How do we automatically detect the DSN and release values from the environment? The simplest way I found to do this was to use the <code class=\"language-text\">onCreateWebpackConfig</code> hook via <code class=\"language-text\">gatsby-node.js</code>. This allows us to Webpack’s <a href=\"https://webpack.js.org/plugins/define-plugin/\"><code class=\"language-text\">DefinePlugin</code></a>. The simplest way to understand this plugin is it does a literal find-and-replace on build (<em>not</em> to be confused with templating). Using this we’re able to detect the environment variables at build time, and inject our <code class=\"language-text\">__SENTRY_DSN__</code> style placeholders:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onCreateWebpackConfig</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> plugins<span class=\"token punctuation\">,</span> actions <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  actions<span class=\"token punctuation\">.</span><span class=\"token function\">setWebpackConfig</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      plugins<span class=\"token punctuation\">.</span><span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        __SENTRY_RELEASE__<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SENTRY_RELEASE</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        __SENTRY_DSN__<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">SENTRY_DSN</span> <span class=\"token operator\">||</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Once I got to this point, I decided to take the environment configuration one step further, and added automatic detection for some of the popular cloud services, including GitHub Actions, Netlify, and Vercel:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// There's more to this list than whats visible here, but you get the idea.</span>\n  __SENTRY_RELEASE__<span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>\n    <span class=\"token comment\">// GitHub Actions - https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables#default-environment-variables</span>\n    process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">GITHUB_SHA</span> <span class=\"token operator\">||</span>\n      <span class=\"token comment\">// Netlify - https://docs.netlify.com/configure-builds/environment-variables/#build-metadata</span>\n      process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">COMMIT_REF</span> <span class=\"token operator\">||</span>\n      <span class=\"token comment\">// Vercel - https://vercel.com/docs/v2/build-step#system-environment-variables</span>\n      process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VERCEL_GITHUB_COMMIT_SHA</span> <span class=\"token operator\">||</span>\n      <span class=\"token comment\">// Zeit (now known as Vercel)</span>\n      process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ZEIT_GITHUB_COMMIT_SHA</span> <span class=\"token operator\">||</span>\n      <span class=\"token string\">\"\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That’s it! The <code class=\"language-text\">@sentry/gatsby</code> integration will be available as part of the next release of <code class=\"language-text\">sentry-javascript</code>. Configuration is as easy as dropping the plugin in your <code class=\"language-text\">gatsby-config.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">plugins<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span>\n    resolve<span class=\"token operator\">:</span> <span class=\"token string\">\"@sentry/gatsby\"</span><span class=\"token punctuation\">,</span>\n    options<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      tracesSampleRate<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>In general I was pretty happy with how well our tracing is working out of the box here, but its not without its warts. We’ve got some improvements to make around how navigation events are captured (they’re a fairly empty trace right now), and we need to provide some hooks so you can indicate the status of the transaction (such as telling Sentry about your 404 handler).</p>\n<p>The one major nit that I have is and I’d love to see Gatsby support better is some degree of integration tests. Right now we’re shipping with next to nothing (we’re only testing exports), but having a way to know that our usage of the APIs works in different versions of Gatsby is fairly critical. We’ll likely explore just bundling a full Gatsby site in the future so at the very least QA is easy.</p>","fields":{"isArchived":false},"frontmatter":{"title":"Instrumenting GatsbyJS with Sentry","date":"June 11, 2020"}}},"pageContext":{"slug":"/instrumenting-gatsbyjs-with-sentry/","previous":{"fields":{"slug":"/optimizing-for-wfh/"},"frontmatter":{"title":"Optimizing for WFH"}},"next":{"fields":{"slug":"/an-honest-review-of-gatsby/"},"frontmatter":{"title":"An Honest Review of Gatsby"}}}}}